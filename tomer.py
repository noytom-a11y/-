# ====================================================
# tomer.py - קובץ הלוגיקה והחישובים (תיקון סופי: חישוב P4 והצגת אתגרים)
# ====================================================
import pandas as pd
from datetime import datetime

# 1. קבועים והגדרות
# ----------------------------------------------
MASTER_NUMBERS = {11, 22}
ALL_MASTER_NUMBERS = {11, 22, 33} 
KARMIC_NUMBERS = {13, 14, 16, 19} # תדרים קארמתיים כולל 16
SPECIAL_NUMBERS = ALL_MASTER_NUMBERS.union(KARMIC_NUMBERS)

ASTRO_MAP = {
    'גדי': 8, 'דלי': 11, 'דגים': 7, 'טלה': 9, 'שור': 33, 'תאומים': 5,
    'מאזניים': 6, 'סרטן': 2, 'אריה': 1, 'בתולה': 4, 'עקרב': 22, 'קשת': 3
}

GIMATRIA_MAP = {
    'א': 1, 'ה': 5, 'ו': 6, 'י': 1, 'ב': 2, 'ג': 3, 'ד': 4, 'ז': 7, 'ח': 8, 
    'ט': 9, 'כ': 2, 'ל': 3, 'מ': 4, 'נ': 5, 'ס': 6, 'ע': 7, 'פ': 8, 'צ': 9, 
    'ק': 1, 'ר': 2, 'ש': 3, 'ת': 4, 
    'ץ': 9, 'ף': 8, 'ם': 4, 'ך': 2, 'ן': 5 
}
VOWEL_LETTERS = {'א', 'ה', 'ו', 'י'}
CONSONANTS = set(GIMATRIA_MAP.keys()) - VOWEL_LETTERS 
VOWELS_MAP = {k: GIMATRIA_MAP[k] for k in VOWEL_LETTERS}


# מפת טקסט עוצמות
STRENGTH_TEXT_MAP = {
    'MASTER': '⭐ תדר מאסטר חזק',
    'STRONG': '✅ תדר חזק ומקדם',
    'MEDIUM': '➖ תדר מאוזן',
    'WEAK': '⚠️ תדר חלש/מעכב',
    'KARMIC': '❌ תדר קארמתי - היזהר',
    'NEUTRAL': '➖ תדר מאוזן (ברירת מחדל)'
}

# 🚨 משפט הקארמה המבוקש
KARMIC_WARNING = "נטייה לחשיבה ראשונה שלילית. רצוי לקבל החלטות רק לאחר שנרגעים ולהתייחס לחשיבה השנייה ולא לראשונה."

# 🚨 מפת תיאורים מרוכזת (כל הנתונים שסופקו, מסוגננים וממוקדים)
CHAKRA_ANALYSIS = {
    'צ\'אקרת הבסיס': {
        1: "הסביבה תופסת את האדם כמוביל טבעי וכדמות סוחפת.",
        2: "הסביבה תופסת את האדם כדמות משפחתית המחפשת זוגיות ויציבות רגשית.",
        3: "הסביבה רואה את האדם כחובב חברה, שמחה, טיולים ובעל אנרגיה קלילה.",
        4: "הסביבה רואה את האדם כמי שמעריך מסגרת, יציבות ובסיס בטוח.",
        5: "הסביבה רואה את האדם כתקשורתי ביותר ובעל יכולת ביטוי גבוהה.",
        6: "הסביבה תופסת אותו כדמות משפחתית ובעלת נתינה גבוהה, לעיתים עד כדי ביטול עצמי וריצוי יתר.",
        7: "בחוויה הפנימית מרגיש שונה (דומה ל-16). בחברה הוא נוטה להיות שקט יותר, אוהב להקשיב, לצפות ולנתח התנהגויות. אוהב לצבור ידע.",
        8: "הסביבה תופסת את האדם כחזק, בעל יכולות ניהוליות גבוהות ומחפש איזון בין רוחניות לגשמיות.",
        9: "הסביבה רואה פוטנציאל גבוה ובלתי ממומש. אדם שנולד להוביל דרך.",
        11: "הסביבה תופסת את האדם כבעל פוטנציאל גדול, אך הוא עלול להתקשות לממשו.",
        13: f"הסביבה רואה אותו כנוקשה, קשה וביקורתי. מתקשה בזוגיות ואוהב שדברים נעשים אך ורק בדרך שלו. {KARMIC_WARNING}",
        14: f"מאופיין בקושי במערכות יחסים זוגיות (דחף לפרקן) ובנטייה לבזבזנות. 'מה שהאדם מרוויח, הכסף יורד לטמיון'. {KARMIC_WARNING}",
        16: f"אדם עם נטייה להפסדים כספיים ובעיות בזוגיות. בחוויה הפנימית מרגיש שונה ועם עיכובים קשים במימוש. {KARMIC_WARNING}",
        19: f"מאופיין בהרגשת קורבנות. מפה חלשה: חווה קורבן. מפה חזקה: נוטה למקרבן בזוגיות. {KARMIC_WARNING}"
    },
    'צ\'אקרת העל': {
        1: "תדר אנרגטי חיובי המקדם את האדם מבחינה אנרגטית.",
        2: "אין השפעה אנרגטית משמעותית על המפה.",
        3: "תדר אנרגטי טוב המקדם את האדם.",
        4: "אין השפעה אנרגטית משמעותית על המפה.",
        5: "תדר אנרגטי טוב המקדם תקשורת. תדר אנרגטי טוב המקדם את האדם.",
        6: "אין השפעה אנרגטית משמעותית על המפה.",
        7: "עלול לגרום לעיכובים קלים ולבעיות נפשיות קלות.",
        8: "תדר אנרגטי טוב המקדם את האדם.",
        9: "תדר אנרגטי טוב המקדם את האדם.",
        11: "תדר אנרגטי טוב המקדם את האדם.",
        13: f"ערך קארמתי המצביע על נוקשות של האדם. {KARMIC_WARNING} | הסביבה רואה אותו כנוקשה, קשה וביקורתי. מתקשה בזוגיות ואוהב שדברים נעשים אך ורק בדרך שלו.",
        14: f"ערך קארמתי. {KARMIC_WARNING} | מאופיין בקושי במערכות יחסים זוגיות (דחף לפרקן) ובנטייה לבזבזנות. 'מה שהאדם מרוויח, הכסף יורד לטמיון'.",
        16: f"ערך קארמתי. {KARMIC_WARNING} | אדם עם נטייה להפסדים כספיים ובעיות בזוגיות. בחוויה הפנימית מרגיש שונה ועם עיכובים קשים במימוש.",
        19: f"ערך קארמתי. {KARMIC_WARNING} | מאופיין בהרגשת קורבנות. מפה חלשה: חווה קורבן. מפה חזקה: נוטה למקרבן בזוגיות."
    },
    'צ\'אקרת המין והיצירה': {
        1: "יכולות תעסוקה מעולות: הצלחה מרובה כמנהיג, מנהל/סמנכ\"ל או עצמאי בכל תחום (כולל עבודת כפיים). אנרגיה חזקה שדוחפת להצלחה ללא תנאי.",
        2: "מתאים לעבודה במתן שירות (פקידות, הוראה, טיפול). נטייה להיות שכיר וקושי בהשגת משכורות גבוהות.",
        3: "כישורי תעסוקה מצוינים, מתאים לעבודה על במה, הוראה, מכירות, תקשורת, מחשבים, ספורט ומוזיקה. מסוגל לעבוד בכל תחום.",
        4: "יכולות תעסוקה בינוניות, מתאים למתן שירות כשכיר. מוטיבציה תעסוקתית לא גבוהה.",
        5: "כישורי תעסוקה ייחודיים ומצוינים בתחומים כמו ספורט, מוזיקה, מחשבים וראיית חשבון. יכולת להגיע לתפקידים בכירים ופוטנציאל גבוה לרווחים.",
        6: "כמו יכולות 4: מתאים יותר למתן שירות כשכיר.",
        7: "כישורי תעסוקה קשים ליישום (הוראה, רפואה, הייטק). רובם עובדים במתן שירות ומתקשים לממש את הפוטנציאל הגבוה.",
        8: "יכולות תעסוקה הטובות בעולם, מתאימות לניהול אנשים, עסקים מצליחים, ייעוץ השקעות, ביטוח ועו\"ד. נמנעים מעבודת כפיים, בעלי יכולת להתמודד עם קהל גדול.",
        9: "יכולות תעסוקה בינוניות. סיכוי נמוך למימוש מלוא הפוטנציאל. נוטה לעבוד במתן שירות (כמו 2, 4, 6).",
        11: f"כמו יכולות 9: נוטה לעבוד במתן שירות ומתקשה לממש פוטנציאל.",
        13: f"יוצר קושי, חוסר סיפוק וקושי במימוש הפוטנציאל. לרוב יהיה שכיר. {KARMIC_WARNING}",
        14: f"כמו יכולות 13. ייחודי בכך שיכול להצטיין גם בתחומי ספורט ומוזיקה. {KARMIC_WARNING}",
        16: f"כמו יכולות 13. יוצר קושי, חוסר סיפוק וקושי במימוש הפוטנציאל. לרוב יהיה שכיר. {KARMIC_WARNING}",
        19: f"מצד אחד יכולות מצוינות (19=1), אך יש קושי להגיע ליכולות של 1. רעיונות מצוינים, קושי גדול ביישום. מצליח לממש עד 70% מהפוטנציאל. נטייה לדברים להשתבש, מוטיבציה גבוהה אך יישום בינוני. {KARMIC_WARNING}",
        22: "כמו יכולות 9: נוטה לעבוד במתן שירות ומתקשה לממש פוטנציאל.",
        33: "כמו יכולות 6/4: נוטה לעבוד במתן שירות ומתקשה לממש פוטנציאל."
    },
    'צ\'אקרת מקלעת השמש': {
        1: "הייעוד הוא להנהיג: להיות לידר, לעמוד על במה, להעביר ידע, להיות עצמאי. אנרגיה מובילה וחזקה המקלה על הצלחה.",
        2: "הייעוד הוא שיתוף פעולה: להיות איש משפחה, לעבוד בצוותים ולטפל. נטייה לרגשנות וחרדות (הצורך בפעולה משותפת).",
        3: "הייעוד הוא קלילות ושמחה: לשמור על הילד הפנימי, לטייל, לבלות בחברה, לעמוד על במה ולהיות שמח. משיכה לספורט, מוזיקה ואסתטיקה.",
        4: "הייעוד הוא יציבות ומסגרת: להיות אדם מסודר ומאורגן שחי במסגרות; אדם משפחתי עם בסיס חזק.",
        5: "הייעוד הוא תקשורת וגבולות: לעמוד על במה, להעביר ידע, תקשורת, מדיה, מחשבים וראיית חשבון. קל להצליח בחיים.",
        6: "הייעוד הוא נתינה ומשפחה: להיות 'מלך המשפחה' ולשרת את הסביבה. נטייה לתחומי אסתטיקה וטיפול. קיים קושי בקבלת עזרה (נטייה לריצוי). קל למימוש.",
        7: "הייעוד הוא התחברות עצמית וידע: להתגבר על חרדות ולחצים, לצבור ידע ולהתחבר לרוחניות. נטייה לפעול מהרגש ולא מהשכל (מומלץ להתנהל שכלית). הייעוד המשני הוא לעמוד על במה כ'חכם' או 'נבדל'.",
        8: "הייעוד הוא איזון וניהול: להיות מנהל, עצמאי עשיר ולפרנס משפחה, תוך איזון בין רוחניות לגשמיות. קשה מאוד למימוש (נדיר). הייעוד המשני הוא העברת ידע.",
        9: "ייעוד מאסטר (הגבוה ביותר): להוביל דרך רוחנית/עולמית, להמציא דברים למען האנושות ולטפל בסביבה. נולד למען אחרים. נדרשת מפה חזקה למימוש.",
        11: "ייעוד מאסטר (המטפל הגדול): המסע שלהם הוא להפוך ממטופל ותלותי לאדם חזק שמטפל באנשים. צריכים מפה חזקה כדי להגשים את ייעוד המאסטר.",
        13: f"הייעוד הוא תיקון קרמתי: להשתחרר ממוגבלות (פיזית/נפשית/מנטלית), מנוקשות, חשיבה שלילית וביקורתיות. למצוא שלווה וחופש. {KARMIC_WARNING}",
        14: f"הייעוד הוא תיקון קרמתי: להשתחרר מדחף בלתי נשלט לחופש מוחלט, לפתח יציבות משפחתית וכלכלית. נטייה לבזבזנות, לקיחת סיכונים והשתעממות. {KARMIC_WARNING}",
        16: f"הייעוד המאתגר ביותר (קארמה רוחנית): טיפול בנפש, התגברות על חרדות, קריסות נפשיות ודיכאון. התיקון הוא חיבור לרוחניות, נתינה, וטיפול באחרים (רפואה, פסיכולוגיה). {KARMIC_WARNING}",
        19: f"הייעוד הוא תיקון קרמתי: להשתחרר מקורבנות וללמוד להיות המנהל (לא הסגן). לרוב חווים ניצול משמעותי בשיא הראשון של החיים. {KARMIC_WARNING}",
        22: "דומה לערך 4, פוטנציאל מאסטר.",
        33: "הייעוד להיות איש משפחה, להשתחרר מרצון לשליטה במשפחה ובבני זוג, להתעסק ברוחניות, כתיבה ויצירה."
    },
    'צ\'אקרת הלב': { # חוסר
        0: "צ'אקרת הלב: במצב מאוזן או במצוקה קארמתית. 0 במינוס (עם קארמה): רצון לקבל ריפוי, נמצא במצוקה וחוסר שביעות רצון פנימית. 0 בפלוס (עם מאסטר): רצון לתת ריפוי, מפה מאוזנת.",
        1: "תחושת חוסר במנהיגות; רצון להוביל יותר. לפעמים מתנהל מאגו.",
        2: "תחושה של חוסר בזוגיות ובמשפחתיות.",
        3: "תחושה של חוסר חופש, קלילות ושמחת חיים.",
        4: "תחושה של רצון מוגבר למסגרתיות, יציבות וסדר.",
        5: "תחושה של חוסר בתקשורת; רצון להיות יותר תקשורתי.",
        6: "תחושה של חוסר במשפחתיות ובאיזון נתינה-קבלה.",
        7: "תחושה של חוסר בידע; רצון ללמוד ולצבור ידע.",
        8: "תחושה של חוסר ביכולות ניהול; צורך באיזון בין הרוחניות לגשמיות ולחזק את יכולות הניהול."
    },
    'צ\'אקרת הגרון': { # חשיבה וביטוי
        0: "אם בפלוס: רצון לרפא את העולם. אם במינוס: רצון לקבל ריפוי. דומה לאנרגיה של 2: קשיים בזוגיות, קושי להיות עצמאי ומצליח לבד.",
        1: "יכולות חשיבה מעולות (ציון 100): חשיבה אנרגטית, שכלתנית ולוגית. 'מלך ברעיונות', יכולת עיבוד נתונים גבוהה, מתאים לתפקידי ניהול ועצמאות.",
        2: "חשיבה מצוינת כשכיר, חלשה כעצמאי. מקשה על זוגיות (חשיבה תלותית). טוב בלימודים.",
        3: "יכולות חשיבה טובות, 'מלך ביצירתיות'. סגנון חשיבה מהיר אך קושי בהתמדה (בעיקר בזוגיות). אנרגיה חברותית ונטייה לסטוצים.",
        4: "אדם ביקורתי (כלפי עצמו ואחרים), פרפקציוניסט. חשיבה מסודרת ואנליטית, טוב כשכיר ובלימודים. קשה ונוקשה, מנסה לשלוט בזוגיות.",
        5: "מלך בתקשורת (ציון 90), חשיבה מצוינת ומהירה. נטייה לפרוץ מסגרות, בזבזנות ונהנתנות. קליטה מצוינת לשפות.",
        6: "חשיבה הססנית, שואף לאיזון. עדיף כשכיר. דחף לטפל באחרים, צורך בשיתופיות. טובים בסחיטה רגשית. טוב לזוגיות.",
        7: "מלך בידע וחוכמה (ציון 100), אך רגשית ציון 20. ההתנהלות בזוגיות מהרגש (גורם לטעויות). נטייה למחלות נפש וחוסר איזון.",
        8: "מלך בתכנון וביצוע. חשיבה הישגית, תכליתית ואנליטית. לוקח סיכונים מחושבים. יודע לשלוט במספרים קארמתיים. מצוין בכל תחום.",
        9: "ראייה מרחבית רחבה, חשיבה אנרגטית אנליטית. יכולות חשיבה לשכיר מעולות. חיסרון: קושי בגביית כסף. מצוין בזוגיות.",
        11: "נוטה להתנהל כ-2. נטייה לגמגום או אפילפסיה.",
        13: "חשיבה מפוצלת, ביקורתי ונוקשה (כלפי עצמו וסביבה). מלך ברעיונות לא ישימים. אדם קיצוני בדעותיו. סובל מהפרעות קשב וריכוז מורכבות. לא מתאים לעצמאי.",
        14: "מייצר בעיות בזוגיות. מלא ברעיונות עסקיים (לא ישימים). יכולת ביטוי מצוינת ותקשורתי. נטייה לקחת סיכונים מעבר לקצה.",
        16: "אנרגיה שמייצרת בעיות ודוחה זוגיות. מלך בעצות לאחרים (לא לעצמו) וברעיונות לא ישימים. פריק שליטה, ביקורתי וציני. נטייה לפשיטות רגל כעצמאי.",
        19: "מנסה לשלוט באנשים אחרים. נוטה לקורבנות או מקרבן. חשיבה וביטוי בינוניים.",
        22: "נוטה להתנהל כ-4 (ביקורתי, מסודר).",
        33: "נוטה להתנהל כ-6, אך חזק יותר בהתמדה."
    },
    'צ\'אקרת העין השלישית': { # תת מודע
        7: "אנרגיה שמייצרת בעיות בזוגיות, חרדות והפסדים כספיים.",
        13: "הופך את האדם לקשה ונוקשה, שהכל צריך להיות אך ורק בדרך שלו.",
        14: "אנרגיה המושכת זוגיות אך מנסה לפרק אותה בכל רגע אפשרי. בנה לעצמו עתיד ללא כסף, זוגיות או מערכות יחסים.",
        16: "האדם בנה לעצמו עתיד עם בעיות בזוגיות, הפסדים כספיים, בעיות נפשיות, חרדות ודיכאונות (מניה דיפרסיה).",
        19: "בחוויה הפנימית עבר אירוע טראומטי. יוצר לעצמו עתיד קורבני, חוסר ביטחון עצמי, בעיות קשב וריכוז ונטייה להתמכרויות.",
    },
    'צ\'אקרת הכתר': { # יום הלידה
        1: "יום לידה חזק: עוזר להתקדם בחיים (במיוחד בשיא 2 ו-3). העולם מזמן הזדמנויות לניהול ולקידום עסקי.",
        2: "יום לידה מעכב: מעכב בתחומים של זוגיות, שיתופי פעולה וקושי בעסקים (לא משפיע לרעה כשכיר).",
        3: "יום לידה מצוין: משיכה לספורט, מוזיקה ואומנות. נטייה להיות עצמאי.",
        4: "יום לידה יציב: היקום מזמן הזדמנויות לרכישת נדל\"ן ונכסים (בשיא 2 ו-3). יום לידה מצוין לשכירים, חלש יחסית לעסקים.",
        5: "יום לידה מצוין: דומה ל-3, עם אנרגיה נוספת של מחשבים, אינטרנט וראיית חשבון. אנשים מיניים עם תקשורת טובה.",
        6: "יום לידה פרווה: לא עוזר ולא מונע. היקום עוזר להקים משפחה.",
        7: "יום לידה מעכב: משפיע לרעה החל מהשיא השני. הכל הולך יותר קשה, מאופיין בהרבה חרדות וקריסות נפשיות. יכול להצליח בספורט.",
        8: "יום לידה מצוין: דוחף לעצמאות וניהול. טריקי: עלול להסתבך עם כספים ורשויות (לעצמאים).",
        9: "יום לידה חזק: מייצר תהפוכות בגיל 2 ו-3. אם האדם יודע להתמודד, התהפוכות יקדמו אותו.",
        11: "יום לידה חזק: נטייה לחרדות וקריסות נפשיות ללא מפה חזקה. דוחף להמצאות רוחניות.",
        13: f"קרמה חונקת. מגיע לשיא בשיא 2 ו-3. מושך לטיפול. {KARMIC_WARNING}",
        14: f"כמו 13: בעיה במסגרות ומערכות יחסים. {KARMIC_WARNING}",
        16: f"כמו 13: קארמה מעכבת רוחנית, משפיע על הנפש. {KARMIC_WARNING}",
        19: f"כמו 13: קארמה מעכבת קורבנית. יש להיזהר שלא להיכנס לכלא בתקופה זו. {KARMIC_WARNING}",
        22: "יום לידה חזק: דוחף קדימה. יש לו את המאסטר החזק ביותר (להמצאות וחידושים). אם נופל, צריך להתרומם לבד.",
        33: "יום לידה חזק: תומך בבניית משפחה יציבה."
    },
    'צ\'אקרת היקום': { # המזל האסטרולוגי
        1: "מזל אריה (מצוין): דוחף קדימה, כריזמטי, מלך ברעיונות ובביצוע. טוב בתפקידי ניהול.",
        2: "מזל סרטן (מעכב): צריך מפה חזקה כדי להתקדם. אנשים תלותיים, טובים כשכירים, חלשים כעצמאים.",
        3: "מזל קשת (מצוין): דוחף קדימה להיות עצמאי. משיכה לספורט, מוזיקה ואומנות.",
        4: "מזל בתולה (יציב): טוב מאוד במסגרות.",
        5: "מזל תאומים (מצוין): דוחף קדימה, חזק בתקשורת. התמחויות בספורט, מחשבים ואינטרנט.",
        6: "מזל מאזניים (פרווה): טוב לפוליטיקה ולמשפחתיות.",
        7: "מזל דגים (מעכב): מייצר קשיים. 100 בשכל, 20 ברגש (נטייה לפעול מהרגש).",
        8: "מזל גדי (מצוין): דוחף קדימה, אך עלול להפוך אנשים למתוסכלים פנימית אם לא מצליחים לממש את הפוטנציאל הגבוה.",
        9: "מזל טלה (מצוין): דוחף קדימה, מתאים לעצמאים. אימפולסיבי (לא תמיד מסיים).",
        11: "מזל דלי (מעכב): נקרא מזל ספונג'ה, מתקשה להגיע לדרגת מאסטר. חייב מפה חזקה.",
        22: "מזל עקרב (החזק ביותר): דוחף קדימה מאוד חזק. ייעוד גבוה להשאיר חותם, להביא המצאות לעולם. יוצר ביטחון עצמי חזק.",
        33: "מזל שור (טוב): מזל יציב, טוב למשפחה. נטייה לשליטה במערכות יחסים."
    }
}


# 2. פונקציות עזר וצמצום 
# ------------------------------------------------
def reduce_number(n, special_rules=True, reduce_all=False):
    """מצמצם מספר. special_rules=True שומר על מאסטרים וקארמה. reduce_all=True תמיד מצמצם לחד-ספרתי."""
    if reduce_all:
        while n > 9:
            n = sum(int(digit) for digit in str(n))
        return n
    
    # בדיקה מול SPECIAL_NUMBERS (כולל קארמה) כדי למנוע צמצום מוקדם
    while n > 9 and n not in SPECIAL_NUMBERS:
        n = sum(int(digit) for digit in str(n))
    return n

def calculate_name_sum(name_part, letters_map, return_unreduced=False):
    """מחשב סכום גימטרי לחלק נתון של השם, מתעלם מאותיות לא מוכרות."""
    total = 0
    name_part = name_part.replace(" ", "")
    for char in name_part:
        if char in letters_map:
            total += letters_map[char]
            
    if return_unreduced: return total
    return reduce_number(total, special_rules=True)

# 3. חישוב תאריך לידה 
# ------------------------------------------------
def get_astro_sign(day, month):
    """מחשב את המזל האסטרולוגי על בסיס יום וחודש."""
    if (month == 3 and day >= 21) or (month == 4 and day <= 19): return 'טלה'
    if (month == 4 and day >= 20) or (month == 5 and day <= 20): return 'שור'
    if (month == 5 and day >= 21) or (month == 6 and day <= 20): return 'תאומים'
    if (month == 6 and day >= 21) or (month == 7 and day <= 22): return 'סרטן'
    if (month == 7 and day >= 23) or (month == 8 and day <= 22): return 'אריה'
    if (month == 8 and day >= 23) or (month == 9 and day <= 22): return 'בתולה'
    if (month == 9 and day >= 23) or (month == 10 and day <= 22): return 'מאזניים'
    if (month == 10 and day >= 23) or (month == 11 and day <= 21): return 'עקרב'
    if (month == 11 and day >= 22) or (month == 12 and day <= 21): return 'קשת'
    if (month == 12 and day >= 22) or (month == 1 and day <= 19): return 'גדי'
    if (month == 1 and day >= 20) or (month == 2 and day <= 18): return 'דלי'
    if (month == 2 and day >= 19) or (month == 3 and day <= 20): return 'דגים'
    return None

def calculate_birth_data(day, month, year):
    """מחשב את תדרי היום, החודש, השנה והייעוד."""
    day_reduced = reduce_number(day, special_rules=True)
    month_val = month 
    month_reduced = reduce_number(month_val, special_rules=True)
    year_reduced = reduce_number(year, special_rules=True) # שנה מצומצמת (שומר מאסטר/קארמה)
    year_reduced_single = reduce_number(year, reduce_all=True)
    destiny_number = reduce_number(day_reduced + month_reduced + year_reduced, special_rules=True)
    astro_sign = get_astro_sign(day, month)
    astro_number = ASTRO_MAP.get(astro_sign, None)
    
    # 🚨 מחזירים את year_reduced (שומר המאסטר)
    return day_reduced, month_val, month_reduced, year_reduced, year_reduced_single, destiny_number, astro_number, astro_sign

# 4. חישוב תדרי שם
# ------------------------------------------------
def calculate_name_freqs(first_name, last_name, destiny_number):
    """מחשב את כל תדרי הצ'אקרות הקשורים לשם."""
    
    all_letters_map = GIMATRIA_MAP 
    
    # שלב 1: חישוב סכום גימטריה מלא לא מופחת
    fn_all_sum_unreduced = calculate_name_sum(first_name, all_letters_map, return_unreduced=True)
    ln_all_sum_unreduced = calculate_name_sum(last_name, all_letters_map, return_unreduced=True)
    
    # חישוב עיצורים (Consonants)
    consonants_map = {k: v for k, v in all_letters_map.items() if k in CONSONANTS}
    fn_consonants_sum_unreduced = calculate_name_sum(first_name, consonants_map, return_unreduced=True)
    ln_consonants_sum_unreduced = calculate_name_sum(last_name, consonants_map, return_unreduced=True)
    
    # חישוב תנועות (Vowels)
    fn_vowels_sum_unreduced = calculate_name_sum(first_name, VOWELS_MAP, return_unreduced=True) 
    ln_vowels_sum_unreduced = calculate_name_sum(last_name, VOWELS_MAP, return_unreduced=True)
    
    # === חישוב תדרי הצ'אקרות (לפי לוגיקת המשתמש) ===
    
    # 1. צ'אקרת העל (שם מלא) - רק שם פרטי (שמירת 16/19/מאסטר)
    name_freq_full = reduce_number(fn_all_sum_unreduced, special_rules=True)
    
    # 2. חישוב ביניים לצ'אקרת התעסוקה והתת-מודע
    fn_reduced = name_freq_full # שם פרטי מצומצם
    ln_reduced = reduce_number(ln_all_sum_unreduced, special_rules=True) # שם משפחה מצומצם
    
    # 3. צ'אקרת המין והיצירה (תעסוקה) - סכום מצומצם + סכום מצומצם (שומר קארמה/מאסטר בשילוב)
    career_freq = reduce_number(fn_reduced + ln_reduced, special_rules=True) 
    
    # 4. צ'אקרת הבסיס (סביבה/עיצורים)
    fn_consonants_reduced = reduce_number(fn_consonants_sum_unreduced, special_rules=True)
    ln_consonants_reduced = reduce_number(ln_consonants_sum_unreduced, special_rules=True)
    env_freq = reduce_number(fn_consonants_reduced + ln_consonants_reduced, special_rules=True)
    
    # 5. תדר חשיבה וביטוי (תנועות)
    fn_vowels_reduced = reduce_number(fn_vowels_sum_unreduced, special_rules=True)
    ln_vowels_reduced = reduce_number(ln_vowels_sum_unreduced, special_rules=True)
    exp_freq = reduce_number(fn_vowels_reduced + ln_vowels_reduced, special_rules=True)

    # 6. תת מודע - חישוב: ייעוד + תעסוקה
    subconscious_freq = reduce_number(destiny_number + career_freq, special_rules=True)
    
    # 7. חוסר (תמיד חד-ספרתי)
    destiny_for_lack = reduce_number(destiny_number, reduce_all=True) 
    career_for_lack = reduce_number(career_freq, reduce_all=True) 
    lack_freq = abs(destiny_for_lack - career_for_lack)

    # הדפסת אבחון זמנית
    print(f"\n--- אבחון צ'אקרות השם ({first_name} {last_name}) ---")
    print(f"צ'אקרת העל (שם פרטי): {name_freq_full}")
    print(f"צ'אקרת המין/יצירה (תעסוקה): {career_freq}")
    print(f"צ'אקרת הבסיס (סביבה): {env_freq}\n")
    # --------------------------------------------
    
    return {
        'סביבתי': env_freq, 'תעסוקה': career_freq, 'חוסר': lack_freq,
        'חשיבה וביטוי': exp_freq, 'תת מודע': subconscious_freq, 'שם מלא': name_freq_full
    }

# 5. חישוב מחזורי חיים (P, W)
# ------------------------------------------------
def calculate_life_cycles(day_reduced, month_val, year_reduced, year_reduced_single, destiny_number):
    """מחשב את 4 מחזורי החיים (P - שיא) ואת רצון היקום/אתגרים (W)."""
    D = day_reduced
    
    M_p = reduce_number(month_val, special_rules=True) 
    
    # 🚨 תיקון P4: Y_p הוא ערך השנה המצומצם ששומר מאסטר/קארמה
    Y_p = year_reduced # משתמשים בערך year_reduced שחושב ב-calculate_birth_data
    
    M_w = reduce_number(month_val, reduce_all=True) 
    D_w = reduce_number(D, reduce_all=True) 
    Y_w = reduce_number(year_reduced_single, reduce_all=True) 
    
    # חישוב תדרים ראשיים (P - שיא)
    p1 = reduce_number(M_p + D, special_rules=True) 
    p2 = reduce_number(D + Y_p, special_rules=True)
    p3 = reduce_number(p1 + p2, special_rules=True)
    
    # 🚨 תיקון P4: M_p + Y_p, ואז צמצום סופי (שומר מאסטר/קארמה)
    p4 = reduce_number(M_p + Y_p, special_rules=True) 
    
    # המתנות (Gifts)
    g1 = M_p 
    g2 = D 
    g3 = D 
    g4 = Y_p 
    
    # חישוב האתגרים (W) חייב להיות לפני יצירת מילון cycles
    w1_val = abs(D_w - M_w); w1 = reduce_number(w1_val, reduce_all=True)
    w2_val = abs(D_w - Y_w); w2 = reduce_number(w2_val, reduce_all=True)
    w3_val = abs(w1 - w2); w3 = reduce_number(w3_val, reduce_all=True)
    w4_val = abs(M_w - Y_w); w4 = reduce_number(w4_val, reduce_all=True)

    cycles = {'1': {'מתנה': g1, 'משאלה/שיא': p1, 'אתגר': w1}, 
             '2': {'מתנה': g2, 'משאלה/שיא': p2, 'אתגר': w2}, 
             '3': {'מתנה': g3, 'משאלה/שיא': p3, 'אתגר': w3}, 
             '4': {'מתנה': g4, 'משאלה/שיא': p4, 'אתגר': w4}}
    
    # חישוב תקופות חיים
    A = reduce_number(destiny_number, reduce_all=True) 
    end1 = 37 - A
    periods = {
        '1': f"0-{end1}",
        '2': f"{end1}-{end1 + 9}",
        '3': f"{end1 + 9}-{end1 + 18}",
        '4': f"{end1 + 18}-120"
    }
    return cycles, periods

# 6. יצירת טקסט עוצמה, DataFrames וניתוח
# ------------------------------------------------
def get_strength_text(freq_name, freq_value, astro_sign=None):
    """מחזירה את טקסט העוצמה על בסיס ערך התדר."""
    is_master = freq_value in ALL_MASTER_NUMBERS
    is_karmic = freq_value in KARMIC_NUMBERS
    
    def get_key(key):
        return STRENGTH_TEXT_MAP.get(key, '➖ תדר מאוזן')

    if freq_name in {'מתנה', 'משאלה/שיא', 'אתגר', 'תדר הייעוד', 'סביבתי', 'תעסוקה', 'חשיבה וביטוי', 'תת מודע', 'שם מלא'}:
        # קארמה לפני מאסטר, שניהם לפני כל השאר
        if is_karmic: return get_key('KARMIC') 
        if is_master: return get_key('MASTER')
        
        # דירוג עבור מספרים חד-ספרתיים
        if freq_value in {1, 5, 8, 9}: return get_key('STRONG')
        if freq_value in {2, 7}: return get_key('WEAK')
        if freq_value in {3, 4, 6}: return get_key('MEDIUM')
        if freq_value == 0: return '⚪ אתגר חזק במיוחד'
        return get_key('NEUTRAL')

    if freq_name == 'תדר אסטרולוגי':
        if astro_sign in {'עקרב', 'שור'}: return get_key('MASTER')
        if astro_sign in {'טלה', 'אריה', 'גדי', 'תאומים', 'קשת'}: return get_key('STRONG')
        if astro_sign in {'מאזניים', 'בתולה'}: return get_key('MEDIUM')
        if astro_sign in {'סרטן', 'דגים', 'דלי'}: return get_key('WEAK')
        return get_key('NEUTRAL')
        
    if freq_name == 'חוסר':
        return 'אין חוסר' if freq_value == 0 else 'קיים חוסר'
        
    return get_key('NEUTRAL')

def get_chakra_description_text(chakra_name, freq_value, map_strength):
    """מחזירה תיאור מילולי על בסיס תדר הצ'אקרה."""
    
    description_map = CHAKRA_ANALYSIS.get(chakra_name)
    if description_map and freq_value in description_map:
        return description_map[freq_value]
    
    # עבור תדר אפס בחוסר (צ'אקרת הלב)
    if chakra_name == 'צ\'אקרת הלב' and freq_value == 0:
        return CHAKRA_ANALYSIS['צ\'אקרת הלב'][0]
    
    return None 

def run_numerology_tool_for_app(day, month, year, first_name, last_name):
    """מריץ את כל החישובים ומחזיר 2 DataFrames נקיים ואת טקסט הניתוח."""
    
    # 🚨 מחזירים את year_reduced הנדרש עבור חישוב מחזורי חיים
    day_reduced, month_val, month_reduced, year_reduced, year_reduced_single, destiny_number, astro_number, astro_sign = \
        calculate_birth_data(day, month, year)
    
    name_freqs = calculate_name_freqs(first_name, last_name, destiny_number)
    
    all_freqs_map = {
        'שם מלא': {'freq': name_freqs['שם מלא'], 'chakra': 'צ\'אקרת העל'}, 
        
        # 🚨 יום לידה (day_reduced) הוא הכתר
        'יום לידה': {'freq': day_reduced, 'chakra': 'צ\'אקרת הכתר'},
        # 🚨 המזל האסטרולוגי (astro_number) הוא היקום
        'מזל אסטרולוגי': {'freq': astro_number, 'chakra': 'צ\'אקרת היקום'},
        
        'תת מודע': {'freq': name_freqs['תת מודע'], 'chakra': 'צ\'אקרת העין השלישית'},
        'חשיבה וביטוי': {'freq': name_freqs['חשיבה וביטוי'], 'chakra': 'צ\'אקרת הגרון'},
        'חוסר': {'freq': name_freqs['חוסר'], 'chakra': 'צ\'אקרת הלב'},
        'ייעוד': {'freq': destiny_number, 'chakra': 'צ\'אקרת מקלעת השמש'},
        'תעסוקה': {'freq': name_freqs['תעסוקה'], 'chakra': 'צ\'אקרת המין והיצירה'},
        'סביבה': {'freq': name_freqs['סביבתי'], 'chakra': 'צ\'אקרת הבסיס'}
    }
    
    # 🚨 סדר הצ'אקרות לתצוגה
    chakra_order = [
        'שם מלא', 
        'מזל אסטרולוגי',  # שורה 2 (צ'אקרת היקום)
        'יום לידה',        # שורה 3 (צ'אקרת הכתר)
        'תת מודע', 
        'חשיבה וביטוי', 
        'חוסר', 
        'ייעוד', 
        'תעסוקה', 
        'סביבה'
    ]
    
    chakra_data = []
    
    # נתונים לניתוח
    analysis_text = []

    for name in chakra_order:
        freq_info = all_freqs_map[name]
        freq = freq_info['freq']
        
        # 🚨 טיפול בחוזק ובתצוגת הערך
        if name == 'יום לידה': 
             strength = get_strength_text('תדר אסטרולוגי', freq, astro_sign=None) 
             value_display = freq
        elif name == 'מזל אסטרולוגי':
             strength = get_strength_text(name, freq, astro_sign=astro_sign) 
             value_display = f"{freq} ({astro_sign})"
        else:
             strength = get_strength_text(name, freq, astro_sign=None)
             value_display = freq

        chakra_data.append([value_display, freq_info['chakra'], freq, name, strength])
        
        # 🚨 יצירת טקסט הניתוח
        description = get_chakra_description_text(freq_info['chakra'], freq, strength)
        if description:
            # הוספת תיאור לצ'אקרות הרלוונטיות
            analysis_text.append(f"**{freq_info['chakra']} ({freq})**: {description}")

    df_chakras = pd.DataFrame(chakra_data, columns=['ערך נומרולוגי (ותדר)', 'שם הצ\'אקרה', '__תדר_נקי', '__שם_תדר_נקי', 'עוצמת התדר'])

    # 🚨 קריאה לפונקציית מחזורי חיים עם year_reduced
    cycles, periods = calculate_life_cycles(day_reduced, month_val, year_reduced, year_reduced_single, destiny_number)
    cycle_data = []
    
    for cycle, values in cycles.items(): 
        period = periods[cycle]
        w_strength = get_strength_text('אתגר', values['אתגר'])
        p_strength = get_strength_text('משאלה/שיא', values['משאלה/שיא'])
        m_strength = get_strength_text('מתנה', values['מתנה'])

        # 🚨 תוקן: מחזירים את האתגר עם התיאור המלא (כדי ש-tomer1.py יוכל לעצב)
        # 🚨 והצגת הערך המספרי בלבד בעמודה הנקייה
        cycle_data.append([
            f"מחזור {cycle}", period, 
            f"{values['מתנה']} ({m_strength})", 
            f"{values['משאלה/שיא']} ({p_strength})", 
            f"{values['אתגר']}", # 🚨 תוקן: הערך המספרי בלבד!
            values['משאלה/שיא'], values['אתגר']
        ])
        
    df_cycles = pd.DataFrame(cycle_data, columns=[
        'מחזור חיים', 'תקופת חיים (גילאים)', 'מתנה (תדר+עוצמה)', 
        'משאל"ה/שיא (תדר+עוצמה)', 'אתגר', # 🚨 שם העמודה הסופי ש-tomer1.py צריך להציג
        '__משאלה_נקי', '__אתגר_נקי' 
    ])
    
    return df_cycles, df_chakras, "\n\n".join(analysis_text)